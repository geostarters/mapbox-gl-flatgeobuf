!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).mapboxglFlatgeobuf=e()}(this,function(){"use strict";const t=4,e=4,n=4,r=new Int32Array(2),s=new Float32Array(r.buffer),i=new Float64Array(r.buffer),o=1===new Uint16Array(new Uint8Array([1,0]).buffer)[0];var a;!function(t){t[t.UTF8_BYTES=1]="UTF8_BYTES",t[t.UTF16_STRING=2]="UTF16_STRING"}(a||(a={}));class u{constructor(t){this.bytes_=t,this.position_=0,this.text_decoder_=new TextDecoder}static allocate(t){return new u(new Uint8Array(t))}clear(){this.position_=0}bytes(){return this.bytes_}position(){return this.position_}setPosition(t){this.position_=t}capacity(){return this.bytes_.length}readInt8(t){return this.readUint8(t)<<24>>24}readUint8(t){return this.bytes_[t]}readInt16(t){return this.readUint16(t)<<16>>16}readUint16(t){return this.bytes_[t]|this.bytes_[t+1]<<8}readInt32(t){return this.bytes_[t]|this.bytes_[t+1]<<8|this.bytes_[t+2]<<16|this.bytes_[t+3]<<24}readUint32(t){return this.readInt32(t)>>>0}readInt64(t){return BigInt.asIntN(64,BigInt(this.readUint32(t))+(BigInt(this.readUint32(t+4))<<BigInt(32)))}readUint64(t){return BigInt.asUintN(64,BigInt(this.readUint32(t))+(BigInt(this.readUint32(t+4))<<BigInt(32)))}readFloat32(t){return r[0]=this.readInt32(t),s[0]}readFloat64(t){return r[o?0:1]=this.readInt32(t),r[o?1:0]=this.readInt32(t+4),i[0]}writeInt8(t,e){this.bytes_[t]=e}writeUint8(t,e){this.bytes_[t]=e}writeInt16(t,e){this.bytes_[t]=e,this.bytes_[t+1]=e>>8}writeUint16(t,e){this.bytes_[t]=e,this.bytes_[t+1]=e>>8}writeInt32(t,e){this.bytes_[t]=e,this.bytes_[t+1]=e>>8,this.bytes_[t+2]=e>>16,this.bytes_[t+3]=e>>24}writeUint32(t,e){this.bytes_[t]=e,this.bytes_[t+1]=e>>8,this.bytes_[t+2]=e>>16,this.bytes_[t+3]=e>>24}writeInt64(t,e){this.writeInt32(t,Number(BigInt.asIntN(32,e))),this.writeInt32(t+4,Number(BigInt.asIntN(32,e>>BigInt(32))))}writeUint64(t,e){this.writeUint32(t,Number(BigInt.asUintN(32,e))),this.writeUint32(t+4,Number(BigInt.asUintN(32,e>>BigInt(32))))}writeFloat32(t,e){s[0]=e,this.writeInt32(t,r[0])}writeFloat64(t,e){i[0]=e,this.writeInt32(t,r[o?0:1]),this.writeInt32(t+4,r[o?1:0])}getBufferIdentifier(){if(this.bytes_.length<this.position_+t+e)throw new Error("FlatBuffers: ByteBuffer is too short to contain an identifier.");let n="";for(let r=0;r<e;r++)n+=String.fromCharCode(this.readInt8(this.position_+t+r));return n}__offset(t,e){const n=t-this.readInt32(t);return e<this.readInt16(n)?this.readInt16(n+e):0}__union(t,e){return t.bb_pos=e+this.readInt32(e),t.bb=this,t}__string(e,n){e+=this.readInt32(e);const r=this.readInt32(e);e+=t;const s=this.bytes_.subarray(e,e+r);return n===a.UTF8_BYTES?s:this.text_decoder_.decode(s)}__union_with_string(t,e){return"string"==typeof t?this.__string(e):this.__union(t,e)}__indirect(t){return t+this.readInt32(t)}__vector(e){return e+this.readInt32(e)+t}__vector_len(t){return this.readInt32(t+this.readInt32(t))}__has_identifier(n){if(n.length!=e)throw new Error("FlatBuffers: file identifier must be length "+e);for(let r=0;r<e;r++)if(n.charCodeAt(r)!=this.readInt8(this.position()+t+r))return!1;return!0}createScalarList(t,e){const n=[];for(let r=0;r<e;++r){const e=t(r);null!==e&&n.push(e)}return n}createObjList(t,e){const n=[];for(let r=0;r<e;++r){const e=t(r);null!==e&&n.push(e.unpack())}return n}}var c,h,l=new Uint8Array(0);function b(t,e){if(!t.length)return e;if(!e.length)return t;var n=new Uint8Array(t.length+e.length);return n.set(t),n.set(e,t.length),n}function d(t){this._source=t,this._array=l,this._index=0}d.prototype.read=function(){var t=this,e=t._array.subarray(t._index);return t._source.read().then(function(n){return t._array=l,t._index=0,n.done?e.length>0?{done:!1,value:e}:{done:!0,value:void 0}:{done:!1,value:b(e,n.value)}})},d.prototype.slice=function(t){if((t|=0)<0)throw new Error("invalid length");var e=this,n=this._array.length-this._index;if(this._index+t<=this._array.length)return Promise.resolve(this._array.subarray(this._index,this._index+=t));var r=new Uint8Array(t);return r.set(this._array.subarray(this._index)),function s(){return e._source.read().then(function(i){return i.done?(e._array=l,e._index=0,n>0?r.subarray(0,n):null):n+i.value.length>=t?(e._array=i.value,e._index=t-n,r.set(i.value.subarray(0,t-n),n),r):(r.set(i.value,n),n+=i.value.length,s())})}()},d.prototype.cancel=function(){return this._source.cancel()},function(t){t[t.Byte=0]="Byte",t[t.UByte=1]="UByte",t[t.Bool=2]="Bool",t[t.Short=3]="Short",t[t.UShort=4]="UShort",t[t.Int=5]="Int",t[t.UInt=6]="UInt",t[t.Long=7]="Long",t[t.ULong=8]="ULong",t[t.Float=9]="Float",t[t.Double=10]="Double",t[t.String=11]="String",t[t.Json=12]="Json",t[t.DateTime=13]="DateTime",t[t.Binary=14]="Binary"}(c||(c={}));class f{constructor(){this.bb=null,this.bb_pos=0}__init(t,e){return this.bb_pos=t,this.bb=e,this}static getRootAsColumn(t,e){return(e||new f).__init(t.readInt32(t.position())+t.position(),t)}static getSizePrefixedRootAsColumn(t,e){return t.setPosition(t.position()+n),(e||new f).__init(t.readInt32(t.position())+t.position(),t)}name(t){const e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__string(this.bb_pos+e,t):null}type(){const t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readUint8(this.bb_pos+t):c.Byte}title(t){const e=this.bb.__offset(this.bb_pos,8);return e?this.bb.__string(this.bb_pos+e,t):null}description(t){const e=this.bb.__offset(this.bb_pos,10);return e?this.bb.__string(this.bb_pos+e,t):null}width(){const t=this.bb.__offset(this.bb_pos,12);return t?this.bb.readInt32(this.bb_pos+t):-1}precision(){const t=this.bb.__offset(this.bb_pos,14);return t?this.bb.readInt32(this.bb_pos+t):-1}scale(){const t=this.bb.__offset(this.bb_pos,16);return t?this.bb.readInt32(this.bb_pos+t):-1}nullable(){const t=this.bb.__offset(this.bb_pos,18);return!t||!!this.bb.readInt8(this.bb_pos+t)}unique(){const t=this.bb.__offset(this.bb_pos,20);return!!t&&!!this.bb.readInt8(this.bb_pos+t)}primaryKey(){const t=this.bb.__offset(this.bb_pos,22);return!!t&&!!this.bb.readInt8(this.bb_pos+t)}metadata(t){const e=this.bb.__offset(this.bb_pos,24);return e?this.bb.__string(this.bb_pos+e,t):null}static startColumn(t){t.startObject(11)}static addName(t,e){t.addFieldOffset(0,e,0)}static addType(t,e){t.addFieldInt8(1,e,c.Byte)}static addTitle(t,e){t.addFieldOffset(2,e,0)}static addDescription(t,e){t.addFieldOffset(3,e,0)}static addWidth(t,e){t.addFieldInt32(4,e,-1)}static addPrecision(t,e){t.addFieldInt32(5,e,-1)}static addScale(t,e){t.addFieldInt32(6,e,-1)}static addNullable(t,e){t.addFieldInt8(7,+e,1)}static addUnique(t,e){t.addFieldInt8(8,+e,0)}static addPrimaryKey(t,e){t.addFieldInt8(9,+e,0)}static addMetadata(t,e){t.addFieldOffset(10,e,0)}static endColumn(t){const e=t.endObject();return t.requiredField(e,4),e}static createColumn(t,e,n,r,s,i,o,a,u,c,h,l){return f.startColumn(t),f.addName(t,e),f.addType(t,n),f.addTitle(t,r),f.addDescription(t,s),f.addWidth(t,i),f.addPrecision(t,o),f.addScale(t,a),f.addNullable(t,u),f.addUnique(t,c),f.addPrimaryKey(t,h),f.addMetadata(t,l),f.endColumn(t)}}class _{constructor(){this.bb=null,this.bb_pos=0}__init(t,e){return this.bb_pos=t,this.bb=e,this}static getRootAsCrs(t,e){return(e||new _).__init(t.readInt32(t.position())+t.position(),t)}static getSizePrefixedRootAsCrs(t,e){return t.setPosition(t.position()+n),(e||new _).__init(t.readInt32(t.position())+t.position(),t)}org(t){const e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__string(this.bb_pos+e,t):null}code(){const t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readInt32(this.bb_pos+t):0}name(t){const e=this.bb.__offset(this.bb_pos,8);return e?this.bb.__string(this.bb_pos+e,t):null}description(t){const e=this.bb.__offset(this.bb_pos,10);return e?this.bb.__string(this.bb_pos+e,t):null}wkt(t){const e=this.bb.__offset(this.bb_pos,12);return e?this.bb.__string(this.bb_pos+e,t):null}codeString(t){const e=this.bb.__offset(this.bb_pos,14);return e?this.bb.__string(this.bb_pos+e,t):null}static startCrs(t){t.startObject(6)}static addOrg(t,e){t.addFieldOffset(0,e,0)}static addCode(t,e){t.addFieldInt32(1,e,0)}static addName(t,e){t.addFieldOffset(2,e,0)}static addDescription(t,e){t.addFieldOffset(3,e,0)}static addWkt(t,e){t.addFieldOffset(4,e,0)}static addCodeString(t,e){t.addFieldOffset(5,e,0)}static endCrs(t){return t.endObject()}static createCrs(t,e,n,r,s,i,o){return _.startCrs(t),_.addOrg(t,e),_.addCode(t,n),_.addName(t,r),_.addDescription(t,s),_.addWkt(t,i),_.addCodeString(t,o),_.endCrs(t)}}!function(t){t[t.Unknown=0]="Unknown",t[t.Point=1]="Point",t[t.LineString=2]="LineString",t[t.Polygon=3]="Polygon",t[t.MultiPoint=4]="MultiPoint",t[t.MultiLineString=5]="MultiLineString",t[t.MultiPolygon=6]="MultiPolygon",t[t.GeometryCollection=7]="GeometryCollection",t[t.CircularString=8]="CircularString",t[t.CompoundCurve=9]="CompoundCurve",t[t.CurvePolygon=10]="CurvePolygon",t[t.MultiCurve=11]="MultiCurve",t[t.MultiSurface=12]="MultiSurface",t[t.Curve=13]="Curve",t[t.Surface=14]="Surface",t[t.PolyhedralSurface=15]="PolyhedralSurface",t[t.TIN=16]="TIN",t[t.Triangle=17]="Triangle"}(h||(h={}));class p{constructor(){this.bb=null,this.bb_pos=0}__init(t,e){return this.bb_pos=t,this.bb=e,this}static getRootAsHeader(t,e){return(e||new p).__init(t.readInt32(t.position())+t.position(),t)}static getSizePrefixedRootAsHeader(t,e){return t.setPosition(t.position()+n),(e||new p).__init(t.readInt32(t.position())+t.position(),t)}name(t){const e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__string(this.bb_pos+e,t):null}envelope(t){const e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readFloat64(this.bb.__vector(this.bb_pos+e)+8*t):0}envelopeLength(){const t=this.bb.__offset(this.bb_pos,6);return t?this.bb.__vector_len(this.bb_pos+t):0}envelopeArray(){const t=this.bb.__offset(this.bb_pos,6);return t?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+t),this.bb.__vector_len(this.bb_pos+t)):null}geometryType(){const t=this.bb.__offset(this.bb_pos,8);return t?this.bb.readUint8(this.bb_pos+t):h.Unknown}hasZ(){const t=this.bb.__offset(this.bb_pos,10);return!!t&&!!this.bb.readInt8(this.bb_pos+t)}hasM(){const t=this.bb.__offset(this.bb_pos,12);return!!t&&!!this.bb.readInt8(this.bb_pos+t)}hasT(){const t=this.bb.__offset(this.bb_pos,14);return!!t&&!!this.bb.readInt8(this.bb_pos+t)}hasTm(){const t=this.bb.__offset(this.bb_pos,16);return!!t&&!!this.bb.readInt8(this.bb_pos+t)}columns(t,e){const n=this.bb.__offset(this.bb_pos,18);return n?(e||new f).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+n)+4*t),this.bb):null}columnsLength(){const t=this.bb.__offset(this.bb_pos,18);return t?this.bb.__vector_len(this.bb_pos+t):0}featuresCount(){const t=this.bb.__offset(this.bb_pos,20);return t?this.bb.readUint64(this.bb_pos+t):BigInt("0")}indexNodeSize(){const t=this.bb.__offset(this.bb_pos,22);return t?this.bb.readUint16(this.bb_pos+t):16}crs(t){const e=this.bb.__offset(this.bb_pos,24);return e?(t||new _).__init(this.bb.__indirect(this.bb_pos+e),this.bb):null}title(t){const e=this.bb.__offset(this.bb_pos,26);return e?this.bb.__string(this.bb_pos+e,t):null}description(t){const e=this.bb.__offset(this.bb_pos,28);return e?this.bb.__string(this.bb_pos+e,t):null}metadata(t){const e=this.bb.__offset(this.bb_pos,30);return e?this.bb.__string(this.bb_pos+e,t):null}static startHeader(t){t.startObject(14)}static addName(t,e){t.addFieldOffset(0,e,0)}static addEnvelope(t,e){t.addFieldOffset(1,e,0)}static createEnvelopeVector(t,e){t.startVector(8,e.length,8);for(let n=e.length-1;n>=0;n--)t.addFloat64(e[n]);return t.endVector()}static startEnvelopeVector(t,e){t.startVector(8,e,8)}static addGeometryType(t,e){t.addFieldInt8(2,e,h.Unknown)}static addHasZ(t,e){t.addFieldInt8(3,+e,0)}static addHasM(t,e){t.addFieldInt8(4,+e,0)}static addHasT(t,e){t.addFieldInt8(5,+e,0)}static addHasTm(t,e){t.addFieldInt8(6,+e,0)}static addColumns(t,e){t.addFieldOffset(7,e,0)}static createColumnsVector(t,e){t.startVector(4,e.length,4);for(let n=e.length-1;n>=0;n--)t.addOffset(e[n]);return t.endVector()}static startColumnsVector(t,e){t.startVector(4,e,4)}static addFeaturesCount(t,e){t.addFieldInt64(8,e,BigInt("0"))}static addIndexNodeSize(t,e){t.addFieldInt16(9,e,16)}static addCrs(t,e){t.addFieldOffset(10,e,0)}static addTitle(t,e){t.addFieldOffset(11,e,0)}static addDescription(t,e){t.addFieldOffset(12,e,0)}static addMetadata(t,e){t.addFieldOffset(13,e,0)}static endHeader(t){return t.endObject()}static finishHeaderBuffer(t,e){t.finish(e)}static finishSizePrefixedHeaderBuffer(t,e){t.finish(e,void 0,!0)}}class g{constructor(){this.bb=null,this.bb_pos=0}__init(t,e){return this.bb_pos=t,this.bb=e,this}static getRootAsGeometry(t,e){return(e||new g).__init(t.readInt32(t.position())+t.position(),t)}static getSizePrefixedRootAsGeometry(t,e){return t.setPosition(t.position()+n),(e||new g).__init(t.readInt32(t.position())+t.position(),t)}ends(t){const e=this.bb.__offset(this.bb_pos,4);return e?this.bb.readUint32(this.bb.__vector(this.bb_pos+e)+4*t):0}endsLength(){const t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__vector_len(this.bb_pos+t):0}endsArray(){const t=this.bb.__offset(this.bb_pos,4);return t?new Uint32Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+t),this.bb.__vector_len(this.bb_pos+t)):null}xy(t){const e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readFloat64(this.bb.__vector(this.bb_pos+e)+8*t):0}xyLength(){const t=this.bb.__offset(this.bb_pos,6);return t?this.bb.__vector_len(this.bb_pos+t):0}xyArray(){const t=this.bb.__offset(this.bb_pos,6);return t?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+t),this.bb.__vector_len(this.bb_pos+t)):null}z(t){const e=this.bb.__offset(this.bb_pos,8);return e?this.bb.readFloat64(this.bb.__vector(this.bb_pos+e)+8*t):0}zLength(){const t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__vector_len(this.bb_pos+t):0}zArray(){const t=this.bb.__offset(this.bb_pos,8);return t?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+t),this.bb.__vector_len(this.bb_pos+t)):null}m(t){const e=this.bb.__offset(this.bb_pos,10);return e?this.bb.readFloat64(this.bb.__vector(this.bb_pos+e)+8*t):0}mLength(){const t=this.bb.__offset(this.bb_pos,10);return t?this.bb.__vector_len(this.bb_pos+t):0}mArray(){const t=this.bb.__offset(this.bb_pos,10);return t?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+t),this.bb.__vector_len(this.bb_pos+t)):null}t(t){const e=this.bb.__offset(this.bb_pos,12);return e?this.bb.readFloat64(this.bb.__vector(this.bb_pos+e)+8*t):0}tLength(){const t=this.bb.__offset(this.bb_pos,12);return t?this.bb.__vector_len(this.bb_pos+t):0}tArray(){const t=this.bb.__offset(this.bb_pos,12);return t?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+t),this.bb.__vector_len(this.bb_pos+t)):null}tm(t){const e=this.bb.__offset(this.bb_pos,14);return e?this.bb.readUint64(this.bb.__vector(this.bb_pos+e)+8*t):BigInt(0)}tmLength(){const t=this.bb.__offset(this.bb_pos,14);return t?this.bb.__vector_len(this.bb_pos+t):0}type(){const t=this.bb.__offset(this.bb_pos,16);return t?this.bb.readUint8(this.bb_pos+t):h.Unknown}parts(t,e){const n=this.bb.__offset(this.bb_pos,18);return n?(e||new g).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+n)+4*t),this.bb):null}partsLength(){const t=this.bb.__offset(this.bb_pos,18);return t?this.bb.__vector_len(this.bb_pos+t):0}static startGeometry(t){t.startObject(8)}static addEnds(t,e){t.addFieldOffset(0,e,0)}static createEndsVector(t,e){t.startVector(4,e.length,4);for(let n=e.length-1;n>=0;n--)t.addInt32(e[n]);return t.endVector()}static startEndsVector(t,e){t.startVector(4,e,4)}static addXy(t,e){t.addFieldOffset(1,e,0)}static createXyVector(t,e){t.startVector(8,e.length,8);for(let n=e.length-1;n>=0;n--)t.addFloat64(e[n]);return t.endVector()}static startXyVector(t,e){t.startVector(8,e,8)}static addZ(t,e){t.addFieldOffset(2,e,0)}static createZVector(t,e){t.startVector(8,e.length,8);for(let n=e.length-1;n>=0;n--)t.addFloat64(e[n]);return t.endVector()}static startZVector(t,e){t.startVector(8,e,8)}static addM(t,e){t.addFieldOffset(3,e,0)}static createMVector(t,e){t.startVector(8,e.length,8);for(let n=e.length-1;n>=0;n--)t.addFloat64(e[n]);return t.endVector()}static startMVector(t,e){t.startVector(8,e,8)}static addT(t,e){t.addFieldOffset(4,e,0)}static createTVector(t,e){t.startVector(8,e.length,8);for(let n=e.length-1;n>=0;n--)t.addFloat64(e[n]);return t.endVector()}static startTVector(t,e){t.startVector(8,e,8)}static addTm(t,e){t.addFieldOffset(5,e,0)}static createTmVector(t,e){t.startVector(8,e.length,8);for(let n=e.length-1;n>=0;n--)t.addInt64(e[n]);return t.endVector()}static startTmVector(t,e){t.startVector(8,e,8)}static addType(t,e){t.addFieldInt8(6,e,h.Unknown)}static addParts(t,e){t.addFieldOffset(7,e,0)}static createPartsVector(t,e){t.startVector(4,e.length,4);for(let n=e.length-1;n>=0;n--)t.addOffset(e[n]);return t.endVector()}static startPartsVector(t,e){t.startVector(4,e,4)}static endGeometry(t){return t.endObject()}static createGeometry(t,e,n,r,s,i,o,a,u){return g.startGeometry(t),g.addEnds(t,e),g.addXy(t,n),g.addZ(t,r),g.addM(t,s),g.addT(t,i),g.addTm(t,o),g.addType(t,a),g.addParts(t,u),g.endGeometry(t)}}class y{constructor(){this.bb=null,this.bb_pos=0}__init(t,e){return this.bb_pos=t,this.bb=e,this}static getRootAsFeature(t,e){return(e||new y).__init(t.readInt32(t.position())+t.position(),t)}static getSizePrefixedRootAsFeature(t,e){return t.setPosition(t.position()+n),(e||new y).__init(t.readInt32(t.position())+t.position(),t)}geometry(t){const e=this.bb.__offset(this.bb_pos,4);return e?(t||new g).__init(this.bb.__indirect(this.bb_pos+e),this.bb):null}properties(t){const e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readUint8(this.bb.__vector(this.bb_pos+e)+t):0}propertiesLength(){const t=this.bb.__offset(this.bb_pos,6);return t?this.bb.__vector_len(this.bb_pos+t):0}propertiesArray(){const t=this.bb.__offset(this.bb_pos,6);return t?new Uint8Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+t),this.bb.__vector_len(this.bb_pos+t)):null}columns(t,e){const n=this.bb.__offset(this.bb_pos,8);return n?(e||new f).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+n)+4*t),this.bb):null}columnsLength(){const t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__vector_len(this.bb_pos+t):0}static startFeature(t){t.startObject(3)}static addGeometry(t,e){t.addFieldOffset(0,e,0)}static addProperties(t,e){t.addFieldOffset(1,e,0)}static createPropertiesVector(t,e){t.startVector(1,e.length,1);for(let n=e.length-1;n>=0;n--)t.addInt8(e[n]);return t.endVector()}static startPropertiesVector(t,e){t.startVector(1,e,1)}static addColumns(t,e){t.addFieldOffset(2,e,0)}static createColumnsVector(t,e){t.startVector(4,e.length,4);for(let n=e.length-1;n>=0;n--)t.addOffset(e[n]);return t.endVector()}static startColumnsVector(t,e){t.startVector(4,e,4)}static endFeature(t){return t.endObject()}static finishFeatureBuffer(t,e){t.finish(e)}static finishSizePrefixedFeatureBuffer(t,e){t.finish(e,void 0,!0)}static createFeature(t,e,n,r){return y.startFeature(t),y.addGeometry(t,e),y.addProperties(t,n),y.addColumns(t,r),y.endFeature(t)}}function v(t){const e=p.getRootAsHeader(t),n=e.featuresCount(),r=e.indexNodeSize(),s=[];for(let t=0;t<e.columnsLength();t++){const n=e.columns(t);if(!n)throw new Error("Column unexpectedly missing");if(!n.name())throw new Error("Column name unexpectedly missing");s.push({name:n.name(),type:n.type(),title:n.title(),description:n.description(),width:n.width(),precision:n.precision(),scale:n.scale(),nullable:n.nullable(),unique:n.unique(),primary_key:n.primaryKey()})}const i=e.crs(),o=i?{org:i.org(),code:i.code(),name:i.name(),description:i.description(),wkt:i.wkt(),code_string:i.codeString()}:null;return{geometryType:e.geometryType(),columns:s,envelope:null,featuresCount:Number(n),indexNodeSize:r,crs:o,title:e.title(),description:e.description(),metadata:e.metadata()}}function w(t,e){const n=[];for(let r=0;r<t.length;r+=2){const s=[t[r],t[r+1]];e&&s.push(e[r>>1]),n.push(s)}return n}new TextEncoder;const m=new TextDecoder;function x(t,e){const n={};if(!e||0===e.length)return n;const r=t.propertiesArray();if(!r)return n;const s=new DataView(r.buffer,r.byteOffset),i=t.propertiesLength();let o=0;for(;o<i;){const t=s.getUint16(o,!0);o+=2;const i=e[t],a=i.name;switch(i.type){case c.Bool:n[a]=!!s.getUint8(o),o+=1;break;case c.Byte:n[a]=s.getInt8(o),o+=1;break;case c.UByte:n[a]=s.getUint8(o),o+=1;break;case c.Short:n[a]=s.getInt16(o,!0),o+=2;break;case c.UShort:n[a]=s.getUint16(o,!0),o+=2;break;case c.Int:n[a]=s.getInt32(o,!0),o+=4;break;case c.UInt:n[a]=s.getUint32(o,!0),o+=4;break;case c.Long:n[a]=Number(s.getBigInt64(o,!0)),o+=8;break;case c.ULong:n[a]=Number(s.getBigUint64(o,!0)),o+=8;break;case c.Float:n[a]=s.getFloat32(o,!0),o+=4;break;case c.Double:n[a]=s.getFloat64(o,!0),o+=8;break;case c.DateTime:case c.String:{const t=s.getUint32(o,!0);o+=4,n[a]=m.decode(r.subarray(o,o+t)),o+=t;break}case c.Json:{const t=s.getUint32(o,!0);o+=4;const e=m.decode(r.subarray(o,o+t));n[a]=JSON.parse(e),o+=t;break}default:throw new Error("Unknown type "+i.type)}}return n}var I=function(t,e){return(I=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function P(t,e,n,r){return new(n||(n=Promise))(function(s,i){function o(t){try{u(r.next(t))}catch(t){i(t)}}function a(t){try{u(r.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,a)}u((r=r.apply(t,e||[])).next())})}function E(t,e){var n,r,s,i,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(s=2&i[0]?r.return:i[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,i[1])).done)return s;switch(r=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,r=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(s=(s=o.trys).length>0&&s[s.length-1])&&(6===i[0]||2===i[0])){o=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){o.label=i[1];break}if(6===i[0]&&o.label<s[1]){o.label=s[1],s=i;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(i);break}s[2]&&o.ops.pop(),o.trys.pop();continue}i=e.call(t,o)}catch(t){i=[6,t],r=0}finally{n=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function F(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function O(t){return this instanceof O?(this.v=t,this):new O(t)}function U(t,e,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,s=n.apply(t,e||[]),i=[];return r={},o("next"),o("throw"),o("return"),r[Symbol.asyncIterator]=function(){return this},r;function o(t){s[t]&&(r[t]=function(e){return new Promise(function(n,r){i.push([t,e,n,r])>1||a(t,e)})})}function a(t,e){try{(n=s[t](e)).value instanceof O?Promise.resolve(n.value.v).then(u,c):h(i[0][2],n)}catch(t){h(i[0][3],t)}var n}function u(t){a("next",t)}function c(t){a("throw",t)}function h(t,e){t(e),i.shift(),i.length&&a(i[0][0],i[0][1])}}var S=function(t){function e(e){var n=t.call(this,e)||this;return Object.defineProperty(n,"name",{value:"RepeaterOverflowError",enumerable:!1}),"function"==typeof Object.setPrototypeOf?Object.setPrototypeOf(n,n.constructor.prototype):n.__proto__=n.constructor.prototype,"function"==typeof Error.captureStackTrace&&Error.captureStackTrace(n,n.constructor),n}return function(t,e){function n(){this.constructor=t}I(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}(e,t),e}(Error);(function(){function t(t){if(t<0)throw new RangeError("Capacity may not be less than 0");this._c=t,this._q=[]}Object.defineProperty(t.prototype,"empty",{get:function(){return 0===this._q.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"full",{get:function(){return this._q.length>=this._c},enumerable:!1,configurable:!0}),t.prototype.add=function(t){if(this.full)throw new Error("Buffer full");this._q.push(t)},t.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()}})(),function(){function t(t){if(t<1)throw new RangeError("Capacity may not be less than 1");this._c=t,this._q=[]}Object.defineProperty(t.prototype,"empty",{get:function(){return 0===this._q.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"full",{get:function(){return!1},enumerable:!1,configurable:!0}),t.prototype.add=function(t){for(;this._q.length>=this._c;)this._q.shift();this._q.push(t)},t.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()}}(),function(){function t(t){if(t<1)throw new RangeError("Capacity may not be less than 1");this._c=t,this._q=[]}Object.defineProperty(t.prototype,"empty",{get:function(){return 0===this._q.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"full",{get:function(){return!1},enumerable:!1,configurable:!0}),t.prototype.add=function(t){this._q.length<this._c&&this._q.push(t)},t.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()}}();function T(t){null!=t&&"function"==typeof t.then&&t.then(L,L)}var C=0,A=1,R=2,M=3,B=4,V=1024,L=function(){};function k(t){var e=t.err,n=Promise.resolve(t.execution).then(function(t){if(null!=e)throw e;return t});return t.err=void 0,t.execution=n.then(function(){},function(){}),void 0===t.pending?n:t.pending.then(function(){return n})}function N(t,e){var n=t.state>=M;return Promise.resolve(e).then(function(e){return!n&&t.state>=B?k(t).then(function(t){return{value:t,done:!0}}):{value:e,done:n}})}function q(t,e){var n,r;if(!(t.state>=R))if(t.state=R,t.onnext(),t.onstop(),null==t.err&&(t.err=e),0!==t.pushes.length||void 0!==t.buffer&&!t.buffer.empty)try{for(var s=F(t.pushes),i=s.next();!i.done;i=s.next()){i.value.resolve()}}catch(t){n={error:t}}finally{try{i&&!i.done&&(r=s.return)&&r.call(s)}finally{if(n)throw n.error}}else G(t)}function G(t){var e,n;if(!(t.state>=M)){t.state<R&&q(t),t.state=M,t.buffer=void 0;try{for(var r=F(t.nexts),s=r.next();!s.done;s=r.next()){var i=s.value,o=void 0===t.pending?k(t):t.pending.then(function(){return k(t)});i.resolve(N(t,o))}}catch(t){e={error:t}}finally{try{s&&!s.done&&(n=r.return)&&n.call(r)}finally{if(e)throw e.error}}t.pushes=[],t.nexts=[]}}function $(t){t.state>=B||(t.state<M&&G(t),t.state=B)}function D(t){if(!(t.state>=A)){t.state=A;var e=function(t,e){if(T(e),t.pushes.length>=V)throw new S("No more than "+V+" pending calls to push are allowed on a single repeater.");if(t.state>=R)return Promise.resolve(void 0);var n,r=void 0===t.pending?Promise.resolve(e):t.pending.then(function(){return e});r=r.catch(function(e){t.state<R&&(t.err=e),$(t)}),t.nexts.length?(t.nexts.shift().resolve(N(t,r)),n=t.nexts.length?Promise.resolve(t.nexts[0].value):new Promise(function(e){return t.onnext=e})):void 0===t.buffer||t.buffer.full?n=new Promise(function(e){return t.pushes.push({resolve:e,value:r})}):(t.buffer.add(r),n=Promise.resolve(void 0));var s=!0,i={},o=n.catch(function(t){if(s)throw t});return i.then=function(t,e){return s=!1,Promise.prototype.then.call(n,t,e)},i.catch=function(t){return s=!1,Promise.prototype.catch.call(n,t)},i.finally=n.finally.bind(n),t.pending=r.then(function(){return o}).catch(function(e){t.err=e,$(t)}),i}.bind(null,t),n=function(t){var e=q.bind(null,t),n=new Promise(function(e){return t.onstop=e});return e.then=n.then.bind(n),e.catch=n.catch.bind(n),e.finally=n.finally.bind(n),e}(t);t.execution=new Promise(function(r){return r(t.executor(e,n))}),t.execution.catch(function(){return q(t)})}}var j,z=new WeakMap,W=function(){function t(t,e){z.set(this,{executor:t,buffer:e,err:void 0,state:C,pushes:[],nexts:[],pending:void 0,execution:void 0,onnext:L,onstop:L})}return t.prototype.next=function(t){T(t);var e=z.get(this);if(void 0===e)throw new Error("WeakMap error");if(e.nexts.length>=V)throw new S("No more than "+V+" pending calls to next are allowed on a single repeater.");if(e.state<=C&&D(e),e.onnext(t),void 0!==e.buffer&&!e.buffer.empty){var n=N(e,e.buffer.remove());if(e.pushes.length){var r=e.pushes.shift();e.buffer.add(r.value),e.onnext=r.resolve}return n}if(e.pushes.length){var s=e.pushes.shift();return e.onnext=s.resolve,N(e,s.value)}return e.state>=R?(G(e),N(e,k(e))):new Promise(function(n){return e.nexts.push({resolve:n,value:t})})},t.prototype.return=function(t){T(t);var e=z.get(this);if(void 0===e)throw new Error("WeakMap error");return G(e),e.execution=Promise.resolve(e.execution).then(function(){return t}),N(e,k(e))},t.prototype.throw=function(t){var e=z.get(this);if(void 0===e)throw new Error("WeakMap error");return e.state<=C||e.state>=R||void 0!==e.buffer&&!e.buffer.empty?(G(e),null==e.err&&(e.err=t),N(e,k(e))):this.next(Promise.reject(t))},t.prototype[Symbol.asyncIterator]=function(){return this},t.race=H,t.merge=Z,t.zip=Y,t.latest=K,t}();function X(t,e){var n,r,s=[],i=function(t){null!=t&&"function"==typeof t[Symbol.asyncIterator]?s.push(t[Symbol.asyncIterator]()):null!=t&&"function"==typeof t[Symbol.iterator]?s.push(t[Symbol.iterator]()):s.push(function(){return U(this,arguments,function(){return E(this,function(n){switch(n.label){case 0:return e.yieldValues?[4,O(t)]:[3,3];case 1:return[4,n.sent()];case 2:n.sent(),n.label=3;case 3:return e.returnValues?[4,O(t)]:[3,5];case 4:return[2,n.sent()];case 5:return[2]}})})}())};try{for(var o=F(t),a=o.next();!a.done;a=o.next()){i(a.value)}}catch(t){n={error:t}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return s}function H(t){var e=this,n=X(t,{returnValues:!0});return new W(function(t,r){return P(e,void 0,void 0,function(){var e,s,i,o,a,u;return E(this,function(c){switch(c.label){case 0:if(!n.length)return r(),[2];s=!1,r.then(function(){e(),s=!0}),c.label=1;case 1:c.trys.push([1,,5,7]),o=void 0,a=0,u=function(){var s,u,c,h,l,b;return E(this,function(d){switch(d.label){case 0:s=a;try{for(l=void 0,u=F(n),c=u.next();!c.done;c=u.next())h=c.value,Promise.resolve(h.next()).then(function(t){t.done?(r(),void 0===i&&(i=t)):a===s&&(a++,e(t))},function(t){return r(t)})}catch(t){l={error:t}}finally{try{c&&!c.done&&(b=u.return)&&b.call(u)}finally{if(l)throw l.error}}return[4,new Promise(function(t){return e=t})];case 1:return void 0===(o=d.sent())?[3,3]:[4,t(o.value)];case 2:d.sent(),d.label=3;case 3:return[2]}})},c.label=2;case 2:return s?[3,4]:[5,u()];case 3:return c.sent(),[3,2];case 4:return[2,i&&i.value];case 5:return r(),[4,Promise.race(n.map(function(t){return t.return&&t.return()}))];case 6:return c.sent(),[7];case 7:return[2]}})})})}function Z(t){var e=this,n=X(t,{yieldValues:!0});return new W(function(t,r){return P(e,void 0,void 0,function(){var e,s,i,o=this;return E(this,function(a){switch(a.label){case 0:if(!n.length)return r(),[2];e=[],s=!1,r.then(function(){var t,n;s=!0;try{for(var r=F(e),i=r.next();!i.done;i=r.next()){(0,i.value)()}}catch(e){t={error:e}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}}),a.label=1;case 1:return a.trys.push([1,,3,4]),[4,Promise.all(n.map(function(n,a){return P(o,void 0,void 0,function(){var o;return E(this,function(u){switch(u.label){case 0:u.trys.push([0,,6,9]),u.label=1;case 1:return s?[3,5]:(Promise.resolve(n.next()).then(function(t){return e[a](t)},function(t){return r(t)}),[4,new Promise(function(t){e[a]=t})]);case 2:return void 0===(o=u.sent())?[3,4]:o.done?(i=o,[2]):[4,t(o.value)];case 3:u.sent(),u.label=4;case 4:return[3,1];case 5:return[3,9];case 6:return n.return?[4,n.return()]:[3,8];case 7:u.sent(),u.label=8;case 8:return[7];case 9:return[2]}})})}))];case 2:return a.sent(),[2,i&&i.value];case 3:return r(),[7];case 4:return[2]}})})})}function Y(t){var e=this,n=X(t,{returnValues:!0});return new W(function(t,r){return P(e,void 0,void 0,function(){var e,s,i,o;return E(this,function(a){switch(a.label){case 0:if(!n.length)return r(),[2,[]];s=!1,r.then(function(){e(),s=!0}),a.label=1;case 1:a.trys.push([1,,6,8]),a.label=2;case 2:return s?[3,5]:(Promise.all(n.map(function(t){return t.next()})).then(function(t){return e(t)},function(t){return r(t)}),[4,new Promise(function(t){return e=t})]);case 3:return void 0===(i=a.sent())?[2]:(o=i.map(function(t){return t.value}),i.some(function(t){return t.done})?[2,o]:[4,t(o)]);case 4:return a.sent(),[3,2];case 5:return[3,8];case 6:return r(),[4,Promise.all(n.map(function(t){return t.return&&t.return()}))];case 7:return a.sent(),[7];case 8:return[2]}})})})}function K(t){var e=this,n=X(t,{yieldValues:!0,returnValues:!0});return new W(function(t,r){return P(e,void 0,void 0,function(){var e,s,i,o,a,u=this;return E(this,function(c){switch(c.label){case 0:if(!n.length)return r(),[2,[]];s=[],i=!1,r.then(function(){var t,n;e();try{for(var r=F(s),o=r.next();!o.done;o=r.next()){(0,o.value)()}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}i=!0}),c.label=1;case 1:return c.trys.push([1,,5,7]),Promise.all(n.map(function(t){return t.next()})).then(function(t){return e(t)},function(t){return r(t)}),[4,new Promise(function(t){return e=t})];case 2:return void 0===(o=c.sent())?[2]:(a=o.map(function(t){return t.value}),o.every(function(t){return t.done})?[2,a]:[4,t(a.slice())]);case 3:return c.sent(),[4,Promise.all(n.map(function(e,n){return P(u,void 0,void 0,function(){var u;return E(this,function(c){switch(c.label){case 0:if(o[n].done)return[2,o[n].value];c.label=1;case 1:return i?[3,4]:(Promise.resolve(e.next()).then(function(t){return s[n](t)},function(t){return r(t)}),[4,new Promise(function(t){return s[n]=t})]);case 2:return void 0===(u=c.sent())?[2,o[n].value]:u.done?[2,u.value]:(a[n]=u.value,[4,t(a.slice())]);case 3:return c.sent(),[3,1];case 4:return[2]}})})}))];case 4:return[2,c.sent()];case 5:return r(),[4,Promise.all(n.map(function(t){return t.return&&t.return()}))];case 6:return c.sent(),[7];case 7:return[2]}})})})}class J{constructor(){this._extraRequestThreshold=262144}extraRequestThreshold(){return this._extraRequestThreshold}setExtraRequestThreshold(t){if(t<0)throw new Error("extraRequestThreshold cannot be negative");this._extraRequestThreshold=t}}J.global=new J,function(t){t[t.Debug=0]="Debug",t[t.Info=1]="Info",t[t.Warn=2]="Warn",t[t.Error=3]="Error"}(j||(j={}));class Q{static debug(...t){this.log(j.Debug,...t)}static info(...t){this.log(j.Info,...t)}static warn(...t){this.log(j.Warn,...t)}static error(...t){this.log(j.Error,...t)}static log(t,...e){if(!(this.logLevel>t))switch(t){case j.Debug:console.debug(...e);break;case j.Info:console.info(...e);break;case j.Warn:console.warn(...e);break;case j.Error:console.error(...e)}}}Q.logLevel=j.Warn;const tt=40,et=16;function nt(t,e){e=Math.min(Math.max(+e,2),65535);let n=t,r=n;do{r+=n=Math.ceil(n/e)}while(1!==n);return r*tt}async function*rt(t,e,n,r){class s{constructor(t,e){this._level=e,this.nodes=t}level(){return this._level}startNode(){return this.nodes[0]}endNode(){return this.nodes[1]}extendEndNodeToNewOffset(t){console.assert(t>this.nodes[1]),this.nodes[1]=t}toString(){return`[NodeRange level: ${this._level}, nodes: ${this.nodes[0]}-${this.nodes[1]}]`}}const{minX:i,minY:o,maxX:a,maxY:u}=n;Q.info(`tree items: ${t}, nodeSize: ${e}`);const c=function(t,e){if(e<2)throw new Error("Node size must be at least 2");if(0===t)throw new Error("Number of items must be greater than 0");let n=t,r=n;const s=[n];do{r+=n=Math.ceil(n/e),s.push(n)}while(1!==n);const i=[];n=r;for(const t of s)i.push(n-t),n-=t;const o=[];for(let t=0;t<s.length;t++)o.push([i[t],i[t]+s[t]]);return o}(t,e),h=c[0][0],l=[(()=>{const t=c.length-1;return new s([0,1],t)})()];for(Q.debug(`starting stream search with queue: ${l}, numItems: ${t}, nodeSize: ${e}, levelBounds: ${c}`);0!=l.length;){const n=l.shift();Q.debug(`popped node: ${n}, queueLength: ${l.length}`);const b=n.startNode(),d=b>=h,[,f]=c[n.level()],_=Math.min(n.endNode()+e,f),p=_-b,g=await r(b*tt,p*tt),y=new Float64Array(g),v=new Uint32Array(g);for(let e=b;e<_;e++){const r=5*(e-b);if(a<y[r+0])continue;if(u<y[r+1])continue;if(i>y[r+2])continue;if(o>y[r+3])continue;const c=v[8+(r<<1)],f=st(v[9+(r<<1)],c);if(d){const n=(()=>{if(e<t-1){const t=5*(e-b+1),n=v[8+(t<<1)];return st(v[9+(t<<1)],n)-f}return null})();yield[f,e-h,n];continue}const _=J.global.extraRequestThreshold()/tt,p=l[l.length-1];if(void 0!==p&&p.level()==n.level()-1&&f<p.endNode()+_){Q.debug(`Merging "nodeRange" request into existing range: ${p}, newOffset: ${p.endNode()} -> ${f}`),p.extendEndNodeToNewOffset(f);continue}const g=(()=>{const t=n.level()-1;return new s([f,f+1],t)})();void 0!==p&&p.level()==g.level()?Q.info(`Same level, but too far away. Pushing new request at offset: ${f} rather than merging with distant ${p}`):Q.info(`Pushing new level for ${g} onto queue with nearestNodeRange: ${p} since there's not already a range for this level.`),l.push(g)}}}function st(t,e){if(0!=(4293918720&t))throw Error("integer is too large to be safely represented");return e+t*2**32}const it=new Uint8Array([102,103,98,3,102,103,98,0]),ot=4;class at{constructor(t,e,n,r){this.headerClient=t,this.header=e,this.headerLength=n,this.indexLength=r}static async open(t){const e=new ut(t),n=(()=>{const t=et;let e,n=0;for(e=0;e<3;e++){n+=t**e*tt}return n})(),r=2024+n;Q.debug(`fetching header. minReqLength: ${r} (assumedHeaderLength: 2024, assumedIndexLength: ${n})`);{const t=new Uint8Array(await e.getRange(0,8,r,"header"));if(!t.subarray(0,3).every((t,e)=>it[e]===t))throw Q.error(`bytes: ${t} != ${it}`),new Error("Not a FlatGeobuf file");Q.debug("magic bytes look good")}let s;{const t=await e.getRange(8,4,r,"header");if((s=new DataView(t).getUint32(0,!0))>10485760||s<8)throw new Error("Invalid header size");Q.debug(`headerLength: ${s}`)}const i=await e.getRange(12,s,r,"header"),o=v(new u(new Uint8Array(i))),a=nt(o.featuresCount,o.indexNodeSize);return Q.debug("completed: opening http reader"),new at(e,o,s,a)}async*selectBbox(t){const e=this.lengthBeforeTree(),n=this.headerClient,r=async function(t,r){return n.getRange(e+t,r,0,"index")},s=[];let i=[];for await(const e of rt(this.header.featuresCount,this.header.indexNodeSize,t,r)){const[t,,]=e;let[,,n]=e;if(!n){Q.info("final feature"),n=J.global.extraRequestThreshold()}if(0==i.length){i.push([t,n]);continue}const r=i[i.length-1],o=t-(r[0]+r[1]);o>J.global.extraRequestThreshold()&&(Q.info(`Pushing new feature batch, since gap ${o} was too large`),s.push(i),i=[]),i.push([t,n])}this.headerClient.logUsage("header+index"),i.length>0&&s.push(i);const o=s.flatMap(t=>this.readFeatureBatch(t));yield*W.merge(o)}lengthBeforeTree(){return it.length+ot+this.headerLength}lengthBeforeFeatures(){return this.lengthBeforeTree()+this.indexLength}buildFeatureClient(){return new ut(this.headerClient.httpClient)}async*readFeatureBatch(t){const[e]=t[0],[n,r]=t[t.length-1],s=n+r-e,i=this.buildFeatureClient();for(const[e]of t)yield await this.readFeature(i,e,s);i.logUsage("feature")}async readFeature(t,e,n){const r=e+this.lengthBeforeFeatures();let s;{const e=await t.getRange(r,4,n,"feature length");s=new DataView(e).getUint32(0,!0)}const i=await t.getRange(r+4,s,n,"feature data"),o=new Uint8Array(i),a=new Uint8Array(s+ot);a.set(o,ot);const c=new u(a);return c.setPosition(ot),y.getRootAsFeature(c)}}class ut{constructor(t){this.bytesEverUsed=0,this.bytesEverFetched=0,this.buffer=new ArrayBuffer(0),this.head=0,this.httpClient="string"==typeof t?new ct(t):t}async getRange(t,e,n,r){this.bytesEverUsed+=e;const s=t-this.head,i=s+e;if(s>=0&&i<=this.buffer.byteLength)return this.buffer.slice(s,i);const o=Math.max(e,n);return this.bytesEverFetched+=o,Q.debug(`requesting for new Range: ${t}-${t+e-1}`),this.buffer=await this.httpClient.getRange(t,o,r),this.head=t,this.buffer.slice(0,e)}logUsage(t){const e=t.split(" ")[0],n=this.bytesEverUsed,r=this.bytesEverFetched,s=(100*n/r).toFixed(2);Q.info(`${e} bytes used/requested: ${n} / ${r} = ${s}%`)}}class ct{constructor(t){this.requestsEverMade=0,this.bytesEverRequested=0,this.url=t}async getRange(t,e,n){this.requestsEverMade+=1,this.bytesEverRequested+=e;const r=`bytes=${t}-${t+e-1}`;return Q.info(`request: #${this.requestsEverMade}, purpose: ${n}), bytes: (this_request: ${e}, ever: ${this.bytesEverRequested}), Range: ${r}`),(await fetch(this.url,{headers:{Range:r}})).arrayBuffer()}}async function*ht(t,e,n){const r="function"==typeof(s=t).slice?s:new d("function"==typeof s.read?s:s.getReader());var s;const i=async t=>await r.slice(t);let o=new Uint8Array(await i(8));if(!o.subarray(0,3).every((t,e)=>it[e]===t))throw new Error("Not a FlatGeobuf file");o=new Uint8Array(await i(4));let a=new u(o);const c=a.readUint32(0);o=new Uint8Array(await i(c));const h=v(a=new u(o));n&&n(h);const{indexNodeSize:l,featuresCount:b}=h;if(l>0){const t=nt(b,l);await i(t)}let f;for(;f=await lt(i,h,e);)yield f}async function lt(t,e,n){let r=new Uint8Array(await t(4,"feature length"));if(0===r.byteLength)return;let s=new u(r);const i=s.readUint32(0);r=new Uint8Array(await t(i,"feature data"));const o=new Uint8Array(i+4);return o.set(r,4),(s=new u(o)).setPosition(ot),n(y.getRootAsFeature(s),e)}class bt{constructor(t){this.propagationStopped,this.defaultPrevented,this.type=t,this.target=null}preventDefault(){this.defaultPrevented=!0}stopPropagation(){this.propagationStopped=!0}}class dt{constructor(){this.disposed=!1}dispose(){this.disposed||(this.disposed=!0,this.disposeInternal())}disposeInternal(){}}function ft(){}function _t(t){for(const e in t)delete t[e]}class pt extends dt{constructor(t){super(),this.eventTarget_=t,this.pendingRemovals_=null,this.dispatching_=null,this.listeners_=null}addEventListener(t,e){if(!t||!e)return;const n=this.listeners_||(this.listeners_={}),r=n[t]||(n[t]=[]);r.includes(e)||r.push(e)}dispatchEvent(t){const e="string"==typeof t,n=e?t:t.type,r=this.listeners_&&this.listeners_[n];if(!r)return;const s=e?new bt(t):t;s.target||(s.target=this.eventTarget_||this);const i=this.dispatching_||(this.dispatching_={}),o=this.pendingRemovals_||(this.pendingRemovals_={});let a;n in i||(i[n]=0,o[n]=0),++i[n];for(let t=0,e=r.length;t<e;++t)if(!1===(a="handleEvent"in r[t]?r[t].handleEvent(s):r[t].call(this,s))||s.propagationStopped){a=!1;break}if(0==--i[n]){let t=o[n];for(delete o[n];t--;)this.removeEventListener(n,ft);delete i[n]}return a}disposeInternal(){this.listeners_&&_t(this.listeners_)}getListeners(t){return this.listeners_&&this.listeners_[t]||void 0}hasListener(t){return!!this.listeners_&&(t?t in this.listeners_:Object.keys(this.listeners_).length>0)}removeEventListener(t,e){const n=this.listeners_&&this.listeners_[t];if(n){const r=n.indexOf(e);-1!==r&&(this.pendingRemovals_&&t in this.pendingRemovals_?(n[r]=ft,++this.pendingRemovals_[t]):(n.splice(r,1),0===n.length&&delete this.listeners_[t]))}}}var gt={CHANGE:"change",ERROR:"error",BLUR:"blur",CLEAR:"clear",CONTEXTMENU:"contextmenu",CLICK:"click",DBLCLICK:"dblclick",DRAGENTER:"dragenter",DRAGOVER:"dragover",DROP:"drop",FOCUS:"focus",KEYDOWN:"keydown",KEYPRESS:"keypress",LOAD:"load",RESIZE:"resize",TOUCHMOVE:"touchmove",WHEEL:"wheel"};function yt(t,e,n,r,s){if(r&&r!==t&&(n=n.bind(r)),s){const r=n;n=function(){t.removeEventListener(e,n),r.apply(this,arguments)}}const i={target:t,type:e,listener:n};return t.addEventListener(e,n),i}function vt(t,e,n,r){return yt(t,e,n,r,!0)}function wt(t){t&&t.target&&(t.target.removeEventListener(t.type,t.listener),_t(t))}class mt extends pt{constructor(){super(),this.on=this.onInternal,this.once=this.onceInternal,this.un=this.unInternal,this.revision_=0}changed(){++this.revision_,this.dispatchEvent(gt.CHANGE)}getRevision(){return this.revision_}onInternal(t,e){if(Array.isArray(t)){const n=t.length,r=new Array(n);for(let s=0;s<n;++s)r[s]=yt(this,t[s],e);return r}return yt(this,t,e)}onceInternal(t,e){let n;if(Array.isArray(t)){const r=t.length;n=new Array(r);for(let s=0;s<r;++s)n[s]=vt(this,t[s],e)}else n=vt(this,t,e);return e.ol_key=n,n}unInternal(t,e){const n=e.ol_key;if(n)!function(t){if(Array.isArray(t))for(let e=0,n=t.length;e<n;++e)wt(t[e]);else wt(t)}(n);else if(Array.isArray(t))for(let n=0,r=t.length;n<r;++n)this.removeEventListener(t[n],e);else this.removeEventListener(t,e)}}mt.prototype.on,mt.prototype.once,mt.prototype.un;const xt="undefined"!=typeof navigator&&void 0!==navigator.userAgent?navigator.userAgent.toLowerCase():"",It=(xt.includes("firefox"),xt.includes("safari")&&!xt.includes("chrom")&&(xt.includes("version/15.4")||/cpu (os|iphone os) 15_4 like mac os x/.test(xt)),xt.includes("webkit")&&xt.includes("edge"),xt.includes("macintosh"),"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof OffscreenCanvas&&(self,WorkerGlobalScope),function(){let t=!1;try{const e=Object.defineProperty({},"passive",{get:function(){t=!0}});window.addEventListener("_",null,e),window.removeEventListener("_",null,e)}catch(t){}}(),new Array(6),{radians:6370997/(2*Math.PI),degrees:2*Math.PI*6370997/360,ft:.3048,m:1,"us-ft":1200/3937});class Pt{constructor(t){this.code_=t.code,this.units_=t.units,this.extent_=void 0!==t.extent?t.extent:null,this.worldExtent_=void 0!==t.worldExtent?t.worldExtent:null,this.axisOrientation_=void 0!==t.axisOrientation?t.axisOrientation:"enu",this.global_=void 0!==t.global&&t.global,this.canWrapX_=!(!this.global_||!this.extent_),this.getPointResolutionFunc_=t.getPointResolution,this.defaultTileGrid_=null,this.metersPerUnit_=t.metersPerUnit}canWrapX(){return this.canWrapX_}getCode(){return this.code_}getExtent(){return this.extent_}getUnits(){return this.units_}getMetersPerUnit(){return this.metersPerUnit_||It[this.units_]}getWorldExtent(){return this.worldExtent_}getAxisOrientation(){return this.axisOrientation_}isGlobal(){return this.global_}setGlobal(t){this.global_=t,this.canWrapX_=!(!t||!this.extent_)}getDefaultTileGrid(){return this.defaultTileGrid_}setDefaultTileGrid(t){this.defaultTileGrid_=t}setExtent(t){this.extent_=t,this.canWrapX_=!(!this.global_||!t)}setWorldExtent(t){this.worldExtent_=t}setGetPointResolution(t){this.getPointResolutionFunc_=t}getPointResolutionFunc(){return this.getPointResolutionFunc_}}const Et=6378137,Ft=Math.PI*Et,Ot=[-Ft,-Ft,Ft,Ft],Ut=[-180,-85,180,85],St=Et*Math.log(Math.tan(Math.PI/2));class Tt extends Pt{constructor(t){super({code:t,units:"m",extent:Ot,global:!0,worldExtent:Ut,getPointResolution:function(t,e){return t/Math.cosh(e[1]/Et)}})}}const Ct=[new Tt("EPSG:3857"),new Tt("EPSG:102100"),new Tt("EPSG:102113"),new Tt("EPSG:900913"),new Tt("http://www.opengis.net/def/crs/EPSG/0/3857"),new Tt("http://www.opengis.net/gml/srs/epsg.xml#3857")];function At(t,e,n){const r=t.length;n=n>1?n:2,void 0===e&&(e=n>2?t.slice():new Array(r));for(let s=0;s<r;s+=n){e[s]=Ft*t[s]/180;let n=Et*Math.log(Math.tan(Math.PI*(+t[s+1]+90)/360));n>St?n=St:n<-St&&(n=-St),e[s+1]=n}return e}function Rt(t,e,n){const r=t.length;n=n>1?n:2,void 0===e&&(e=n>2?t.slice():new Array(r));for(let s=0;s<r;s+=n)e[s]=180*t[s]/Ft,e[s+1]=360*Math.atan(Math.exp(t[s+1]/Et))/Math.PI-90;return e}const Mt=[-180,-90,180,90],Bt=6378137*Math.PI/180;class Vt extends Pt{constructor(t,e){super({code:t,units:"degrees",extent:Mt,axisOrientation:e,global:!0,metersPerUnit:Bt,worldExtent:Mt})}}const Lt=[new Vt("CRS:84"),new Vt("EPSG:4326","neu"),new Vt("urn:ogc:def:crs:OGC:1.3:CRS84"),new Vt("urn:ogc:def:crs:OGC:2:84"),new Vt("http://www.opengis.net/def/crs/OGC/1.3/CRS84"),new Vt("http://www.opengis.net/gml/srs/epsg.xml#4326","neu"),new Vt("http://www.opengis.net/def/crs/EPSG/0/4326","neu")];let kt={};function Nt(t,e,n){const r=t.getCode(),s=e.getCode();r in kt||(kt[r]={}),kt[r][s]=n}function qt(t,e){if(void 0!==e){for(let n=0,r=t.length;n<r;++n)e[n]=t[n];e=e}else e=t.slice();return e}function Gt(t){t.getCode(),Nt(t,t,qt)}function $t(t){!function(t){t.forEach(Gt)}(t),t.forEach(function(e){t.forEach(function(t){e!==t&&Nt(e,t,qt)})})}var Dt,jt,zt;function Wt(t,e,n){if(!n||0===n.length)return[w(t,e)];let r=0;const s=Array.from(n).map(e=>t.slice(r,r=e<<1));let i;return e&&(r=0,i=Array.from(n).map(t=>e.slice(r,r=t))),s.map((t,e)=>w(t,i?i[e]:void 0))}function Xt(t,e){let n=e;if(n===h.Unknown&&(n=t.type()),n===h.GeometryCollection){const e=[];for(let n=0;n<t.partsLength();n++){const r=t.parts(n),s=r.type();e.push(Xt(r,s))}return{type:h[n],geometries:e}}if(n===h.MultiPolygon){const e=[];for(let n=0;n<t.partsLength();n++)e.push(Xt(t.parts(n),h.Polygon));return{type:h[n],coordinates:e.map(t=>t.coordinates)}}const r=function(t,e){const n=t.xyArray(),r=t.zArray();switch(e){case h.Point:{const t=Array.from(n);return r&&t.push(r[0]),t}case h.MultiPoint:case h.LineString:return w(n,r);case h.MultiLineString:case h.Polygon:return Wt(n,r,t.endsArray())}}(t,n);return{type:h[n],coordinates:r}}function Ht(t,e){const n=e.columns;return{type:"Feature",geometry:Xt(t.geometry(),e.geometryType),properties:x(t,n)}}function Zt(t,e){return{type:"FeatureCollection",features:function(t,e,n){if(!t.subarray(0,3).every((t,e)=>it[e]===t))throw new Error("Not a FlatGeobuf file");const r=new u(t),s=r.readUint32(it.length);r.setPosition(it.length+ot);const i=v(r);n&&n(i);let o=it.length+ot+s;const{indexNodeSize:a,featuresCount:c}=i;a>0&&(o+=nt(c,a));const h=[];for(;o<r.capacity();){const t=r.readUint32(o);r.setPosition(o+ot);const n=y.getRootAsFeature(r);h.push(e(n,i)),o+=ot+t}return h}(t,Ht,e)}}function Yt(t,e,n){return async function*(t,e,n,r){const s=await at.open(t);Q.debug("opened reader"),r&&r(s.header);for await(const t of s.selectBbox(e))yield n(t,s.header)}(t,e,Ht,n)}function Kt(t,e,n){return t instanceof Uint8Array?Zt(t,n):t instanceof ReadableStream?function(t,e){return ht(t,Ht,e)}(t,n):Yt(t,e,n)}$t(Ct),$t(Lt),Dt=Ct,jt=At,zt=Rt,Lt.forEach(function(t){Dt.forEach(function(e){Nt(t,e,jt),Nt(e,t,zt)})});var Jt=Math.PI/180,Qt=180/Math.PI;function te(t){var e=ee(t[0]+1,t[2]);return[ee(t[0],t[2]),ne(t[1]+1,t[2]),e,ne(t[1],t[2])]}function ee(t,e){return t/Math.pow(2,e)*360-180}function ne(t,e){var n=Math.PI-2*Math.PI*t/Math.pow(2,e);return Qt*Math.atan(.5*(Math.exp(n)-Math.exp(-n)))}function re(t,e,n){var r=ce(t,e,n);return r[0]=Math.floor(r[0]),r[1]=Math.floor(r[1]),r}function se(t){return[[2*t[0],2*t[1],t[2]+1],[2*t[0]+1,2*t[1],t[2]+1],[2*t[0]+1,2*t[1]+1,t[2]+1],[2*t[0],2*t[1]+1,t[2]+1]]}function ie(t){return[t[0]>>1,t[1]>>1,t[2]-1]}function oe(t){return se(ie(t))}function ae(t,e){for(var n=0;n<t.length;n++)if(ue(t[n],e))return!0;return!1}function ue(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function ce(t,e,n){var r=Math.sin(e*Jt),s=Math.pow(2,n),i=s*(t/360+.5);return(i%=s)<0&&(i+=s),[i,s*(.5-.25*Math.log((1+r)/(1-r))/Math.PI),n]}var he={tileToGeoJSON:function(t){var e=te(t);return{type:"Polygon",coordinates:[[[e[0],e[3]],[e[0],e[1]],[e[2],e[1]],[e[2],e[3]],[e[0],e[3]]]]}},tileToBBOX:te,getChildren:se,getParent:ie,getSiblings:oe,hasTile:ae,hasSiblings:function(t,e){for(var n=oe(t),r=0;r<n.length;r++)if(!ae(e,n[r]))return!1;return!0},tilesEqual:ue,tileToQuadkey:function(t){for(var e="",n=t[2];n>0;n--){var r=0,s=1<<n-1;0!=(t[0]&s)&&r++,0!=(t[1]&s)&&(r+=2),e+=r.toString()}return e},quadkeyToTile:function(t){for(var e=0,n=0,r=t.length,s=r;s>0;s--){var i=1<<s-1,o=+t[r-s];1===o&&(e|=i),2===o&&(n|=i),3===o&&(e|=i,n|=i)}return[e,n,r]},pointToTile:re,bboxToTile:function(t){var e=re(t[0],t[1],32),n=re(t[2],t[3],32),r=[e[0],e[1],n[0],n[1]],s=function(t){for(var e=0;e<28;e++){var n=1<<32-(e+1);if((t[0]&n)!=(t[2]&n)||(t[1]&n)!=(t[3]&n))return e}return 28}(r);return 0===s?[0,0,0]:[r[0]>>>32-s,r[1]>>>32-s,s]},pointToTileFraction:ce};return class{constructor(t,e,n,r){if(!t||!e||!n)throw new Error("Source id, map and url must be supplied as the first three arguments.");if(!n.url)throw new Error("A url must be supplied as part of the flatGeobufOptions object.");if(!n.idProperty)throw new Error("A idProperty must be supplied as part of the flatGeobufOptions object.");this.sourceId=t,this._map=e,this._flatGeobufOptions=Object.assign(n,{minZoom:9}),this._options=r||{},this._fc=this._getBlankFc(),this._map.addSource(t,Object.assign(this._options,{type:"geojson",data:this._fc})),this._maxExtent=[-1/0,1/0,-1/0,1/0],this._tileIds=new Map,this._fcIds=new Map,this.enableRequests(),this._getTileData()}destroySource(){this.disableRequests(),this._map.removeSource(this.sourceId)}disableRequests(){this._map.off("moveend",this._boundEvent)}enableRequests(){this._boundEvent=this._getTileData.bind(this),this._map.on("moveend",this._boundEvent)}_getBlankFc(){return{type:"FeatureCollection",features:[]}}async _getTileData(){if(this._map.getZoom()<this._flatGeobufOptions.minZoom)return;const t=this._map.getBounds().toArray(),e=he.bboxToTile([t[0][0],t[0][1],t[1][0],t[1][1]]),n=[];if(e[2]<this._flatGeobufOptions.minZoom){let r=he.getChildren(e),s=r[0][2];for(;s<this._flatGeobufOptions.minZoom;){const t=[];r.forEach(e=>t.push(...he.getChildren(e))),s=(r=t)[0][2]}for(let e=0;e<r.length;e++){const s=r[e];this._doesTileOverlapBbox(s,t)&&n.push(s)}}else n.push(e);for(let t=0;t<n.length;t++){const e=n[t],r=he.tileToQuadkey(e);this._tileIds.has(r)?(n.splice(t,1),t--):this._tileIds.set(r,!0)}if(0===n.length)return;const r=function(t){let e=1/0,n=-1/0,r=1/0,s=-1/0;for(let i=0;i<t.length;i++){const o=he.tileToBBOX(t[i]);e=Math.min(e,o[0]),n=Math.max(n,o[2]),r=Math.min(r,o[1]),s=Math.max(s,o[3])}return[e,r,n,s]}(n);let s=this._loadData(r);await this.iterateItems(s),this._updateFc()}async iterateItems(t){for await(let e of t)this._fcIds.has(e.properties[this._flatGeobufOptions.idProperty])||(this._fc.features.push(e),this._fcIds.set(e.properties[this._flatGeobufOptions.idProperty]))}_updateFc(t){this._map.getSource(this.sourceId).setData(this._fc)}_doesTileOverlapBbox(t,e){const n=4===t.length?t:he.tileToBBOX(t);return!(n[2]<e[0][0]||n[0]>e[1][0]||n[3]<e[0][1]||n[1]>e[1][1])}_loadData(t){return Kt(this._flatGeobufOptions.url,function(t){return{minX:t[0],maxX:t[2],minY:t[1],maxY:t[3]}}(t))}}});
